# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

schedules:
- cron: "0 14 * * *"
  displayName: Cron is UTC so this is 12am Sydney time
  branches:
    include:
    - main
  always: true

pool:
  vmImage: ubuntu-latest

variables:
- group: "security-key-vault"

steps:
- script: |
    echo "ArtifactStagingDirectory : $(Build.ArtifactStagingDirectory)"

    docker run --rm -v "$(Build.ArtifactStagingDirectory)/output":/app/output -e SNYK_TOKEN=$SNYKTOKEN -e GITHUB_TOKEN=$GITHUBTOKEN \
               repo_diff \
               --out-file output/repos-with-no-projects.csv \
               --snyk-group  "4d62001b-9ab4-446a-815c-bf51ea2b129b" \
               --github-org prospa-group
  displayName: 'Run repo-diff'

# publish artifact
- task: PublishBuildArtifacts@1
  displayName: Publish Output to Artifactory
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/output/repos-with-no-projects.csv'
